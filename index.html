<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Pronóstico NMME – Lluvia acumulada (México)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
#map { position:absolute; top:80px; bottom:0; left:0; right:0; z-index:1; }

/* ================= HEADER ================= */
#site-header{
  position: fixed; top: 0; left: 0; right: 0; height: 80px;
  background: #ffffff; display: flex; justify-content: space-between; align-items: center;
  padding: 0 28px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 3000;
}
.header-left{ display: flex; align-items: center; gap: 14px; }
.header-left img{ height: 52px; }
.header-text .brand{ font-size: 32px; font-weight: 800; color: #2c6cb0; line-height: 1.1; }
.header-text .tagline{ font-size: 20px; font-weight: 800; color: #2c6cb0; }
.btn-contacto{
  border: 1px solid #2c6cb0; padding: 8px 14px; border-radius: 6px;
  text-decoration: none; color: #2c6cb0; font-size: 13px; transition: all 0.2s ease;
}
.btn-contacto:hover{ background: #2c6cb0; color: white; }

/* ================= MENU PANEL ================= */
#menu-panel{
  position:absolute; top:110px; left:50%; transform:translateX(-50%);
  background:rgba(255,255,255,0.96); padding:14px 18px; border-radius:14px;
  box-shadow:0 6px 20px rgba(0,0,0,0.18); z-index:2000; min-width:360px;
}
.menu-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.menu-title{ font-size:15px; font-weight:800; color:#1f3b5c; margin:0; }
.menu-subtitle{ display:block; font-size:12px; font-weight:500; color:#6b7c93; margin-top:2px; }

#menuToggleBtn{
  display:none;
  border:1px solid #cbd5e1;
  background:white;
  border-radius:10px;
  padding:6px 10px;
  font-size:16px;
  line-height:1;
  cursor:pointer;
}
#menuBody{ margin-top:10px; }
#menuBody.is-collapsed{ display:none; }

.menu-controls{ display:flex; align-items:center; justify-content:space-between; gap:14px; }
.toggle-container{ display:flex; align-items:center; gap:8px; font-size:13px; font-weight:600; color:#333; }
.period-container{ display:flex; align-items:center; gap:6px; }
.period-container label{ font-size:12px; font-weight:600; color:#444; }
.period-container select{ font-size:12px; padding:6px 8px; border-radius:8px; border:1px solid #ccc; background:white; }

/* Toggle switch */
.switch{ position:relative; display:inline-block; width:44px; height:22px; }
.switch input{ opacity:0; width:0; height:0; }
.slider-toggle{
  position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
  background:#ccc; transition:.3s; border-radius:22px;
}
.slider-toggle:before{
  position:absolute; content:""; height:18px; width:18px; left:2px; bottom:2px;
  background:white; transition:.3s; border-radius:50%;
}
.switch input:checked + .slider-toggle{ background:#2c6cb0; }
.switch input:checked + .slider-toggle:before{ transform:translateX(22px); }

/* Hover box */
#hoverBox{
  position:fixed; z-index:2000; background:rgba(255,255,255,0.95);
  padding:6px 8px; border-radius:8px; box-shadow:0 0 6px rgba(0,0,0,0.3);
  font-size:11px; pointer-events:none; display:none;
}

/* Legend */
.legend{
  background:white; padding:10px 10px; font-size:12px; border-radius:10px;
  box-shadow:0 0 15px rgba(0,0,0,0.3);
  min-width: 160px;
}
.legend-header{
  display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
}
.legend-title{ font-weight:800; color:#1f3b5c; font-size:12px; }
.legend-toggle{
  border:1px solid #cbd5e1; background:white; border-radius:8px;
  padding:4px 8px; font-size:12px; cursor:pointer;
}
.legend-body.is-collapsed{ display:none; }
.legend-row{ display:flex; align-items:center; }
.legend-color-box{ width:16px; height:16px; margin-right:6px; border:1px solid #ccc; border-radius:3px; }

/* Raster nítido */
canvas { image-rendering: pixelated; image-rendering: crisp-edges; }

/* ================= RESPONSIVE (MÓVIL) ================= */
@media (max-width: 600px){
  #site-header{ height: 64px; padding: 0 12px; }
  .header-left img{ height: 42px; }
  .header-text .brand{ font-size: 20px; }
  .header-text .tagline{ font-size: 12px; font-weight: 700; }
  #map{ top:64px; }

  #menu-panel{
    top: 74px;
    left: 10px;
    right: 10px;
    transform: none;
    min-width: unset;
    border-radius: 14px;
    padding: 10px 12px;
  }

  .menu-title{ font-size: 14px; }
  .menu-subtitle{ font-size: 11px; }

  #menuToggleBtn{ display:inline-flex; align-items:center; justify-content:center; }

  .menu-controls{ flex-direction: column; align-items: stretch; gap:10px; }
  .period-container{ justify-content: space-between; }
  .period-container select{ width: 100%; }

  #hoverBox{ font-size: 10px; }

  .legend{ font-size: 11px; padding: 8px 8px; }
}
</style>
</head>

<body>
<header id="site-header">
  <div class="header-left">
    <img src="logo2.jpeg" alt="ClimaproAgro logo">
    <div class="header-text">
      <div class="brand">ClimaproAgro</div>
      <div class="tagline">Información Climática para la Agricultura</div>
    </div>
  </div>
  <div class="header-right">
    <a href="https://www.climaproagro.com/contacto" class="btn-contacto">Contacto</a>
  </div>
</header>

<div id="menu-panel">
  <div class="menu-header">
    <div>
      <div class="menu-title">Pronóstico NMME – Lluvia acumulada</div>
      <span class="menu-subtitle">México</span>
    </div>
    <button id="menuToggleBtn" type="button" aria-label="Mostrar/Ocultar panel">☰</button>
  </div>

  <div id="menuBody">
    <div class="menu-controls">
      <div class="toggle-container">
        <span>Mensual</span>
        <label class="switch">
          <input type="checkbox" id="typeToggle">
          <span class="slider-toggle"></span>
        </label>
        <span>Bimestral</span>
      </div>

      <div class="period-container">
        <label for="periodSelect">Periodo</label>
        <select id="periodSelect"></select>
      </div>
    </div>
  </div>
</div>

<div id="map"></div>
<div id="hoverBox"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let currentData = null;
const VAR_LABEL = "Lluvia acumulada";
const VAR_UNITS = "mm";

let currentType = "mensual";
let steps = [];
let map, rasterOverlay, legend;

/* ================= UTILS ================= */
function monthNameEs(m){
  return ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][m-1];
}
function prettyFromName(f){
  let m = f.match(/_(\d{6})_(\d{6})/);
  if (m) return `${monthNameEs(+m[1].slice(4))}–${monthNameEs(+m[2].slice(4))} ${m[1].slice(0,4)}`;
  m = f.match(/_(\d{6})/);
  if (m) return `${monthNameEs(+m[1].slice(4))} ${m[1].slice(0,4)}`;
  return f;
}

/* ================= MAP ================= */
function initMap(){
  map = L.map("map", { zoomControl: true }).setView([23,-102],5);

  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
    { attribution: "© OpenStreetMap, © CARTO" }
  ).addTo(map);

  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png",
    { opacity: 0.6 }
  ).addTo(map);

  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png",
    { opacity: 0.9 }
  ).addTo(map);

  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png",
    { opacity: 0.15 }
  ).addTo(map);

  // Legend control
  legend = L.control({ position: "bottomright" });
  legend.onAdd = function(){
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = `
      <div class="legend-header">
        <div class="legend-title">Leyenda</div>
        <button class="legend-toggle" type="button">Ocultar</button>
      </div>
      <div class="legend-body">Cargando…</div>
    `;
    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.disableScrollPropagation(div);
    return div;
  };
  legend.addTo(map);

  // Hover
  map.on("mousemove", e => {
    if (!currentData) return;

    const val = valueAtPixel(e.latlng);
    const box = document.getElementById("hoverBox");

    if (val === null){
      box.style.display = "none";
      return;
    }

    box.innerHTML = `
      <b>${VAR_LABEL}</b><br>
      Valor: <b>${val.toFixed(1)} ${VAR_UNITS}</b><br>
      Lat: ${e.latlng.lat.toFixed(2)}°<br>
      Lon: ${e.latlng.lng.toFixed(2)}°<br>
      Tipo: ${currentType === "mensual" ? "Mensual" : "Bimestral"}
    `;
    box.style.left = (e.originalEvent.pageX + 15) + "px";
    box.style.top  = (e.originalEvent.pageY + 15) + "px";
    box.style.display = "block";
  });

  map.on("mouseout", () => {
    document.getElementById("hoverBox").style.display = "none";
  });
}

/* ================= Punto 1: México + estados (geoBoundaries API, Ruta 1 real) ================= */
const GB_API_ADM0 = "https://www.geoboundaries.org/api/current/gbOpen/MEX/ADM0/";
const GB_API_ADM1 = "https://www.geoboundaries.org/api/current/gbOpen/MEX/ADM1/";

let mxStatesLayer = null;
let mxCountryLayer = null;

const STATE_LINE_WEIGHT   = 1.0; // estados
const COUNTRY_LINE_WEIGHT = 1.5; // borde nacional solicitado

async function fetchGeoBoundariesGeoJSON(apiUrl) {
  const metaRes = await fetch(apiUrl, { cache: "no-store" });
  if (!metaRes.ok) throw new Error(`No pude leer geoBoundaries API: ${apiUrl}`);

  const meta = await metaRes.json();
  const obj = Array.isArray(meta) ? meta[0] : meta;

  const gjUrl = obj.gjDownloadURL || obj.gjDownloadUrl || obj.gjdownloadURL;
  if (!gjUrl) throw new Error(`No encontré gjDownloadURL en respuesta de: ${apiUrl}`);

  const gjRes = await fetch(gjUrl, { cache: "no-store" });
  if (!gjRes.ok) throw new Error(`No pude descargar GeoJSON: ${gjUrl}`);

  return await gjRes.json();
}

async function loadMexicoBoundaries(){
  try {
    const [countryGeojson, statesGeojson] = await Promise.all([
      fetchGeoBoundariesGeoJSON(GB_API_ADM0),
      fetchGeoBoundariesGeoJSON(GB_API_ADM1),
    ]);

    if (mxStatesLayer) map.removeLayer(mxStatesLayer);
    if (mxCountryLayer) map.removeLayer(mxCountryLayer);

    // Estados
    mxStatesLayer = L.geoJSON(statesGeojson, {
      interactive: false,
      style: { color: "#2b2b2b", weight: STATE_LINE_WEIGHT, opacity: 0.55, fillOpacity: 0 }
    }).addTo(map);

    // Borde nacional 1.5px
    mxCountryLayer = L.geoJSON(countryGeojson, {
      interactive: false,
      style: { color: "#111111", weight: COUNTRY_LINE_WEIGHT, opacity: 0.9, fillOpacity: 0 }
    }).addTo(map);

    // Limitar vista a México
    const boundsMx = mxCountryLayer.getBounds();
    map.fitBounds(boundsMx.pad(0.03));
    map.setMaxBounds(boundsMx.pad(0.08));
  } catch (err){
    console.error("[Mexico boundaries]", err);
  }
}

/* ================= Punto 2: Panel colapsable (móvil) + leyenda colapsable ================= */
function setupCollapsibles(){
  const menuPanel = document.getElementById("menu-panel");
  const menuBody  = document.getElementById("menuBody");
  const menuBtn   = document.getElementById("menuToggleBtn");

  // Evitar que el panel capture drag/scroll del mapa
  if (menuPanel){
    L.DomEvent.disableClickPropagation(menuPanel);
    L.DomEvent.disableScrollPropagation(menuPanel);
  }

  const isMobile = window.matchMedia && window.matchMedia("(max-width: 600px)").matches;

  // Panel colapsado por defecto en móvil
  if (isMobile){
    menuBody.classList.add("is-collapsed");
    menuBtn.textContent = "☰";
  }

  menuBtn.addEventListener("click", () => {
    const collapsed = menuBody.classList.toggle("is-collapsed");
    menuBtn.textContent = collapsed ? "☰" : "✕";
  });

  // Leyenda colapsable
  const legendEl = document.querySelector(".legend");
  if (!legendEl) return;

  const legendBtn  = legendEl.querySelector(".legend-toggle");
  const legendBody = legendEl.querySelector(".legend-body");

  if (isMobile && legendBody){
    legendBody.classList.add("is-collapsed");
    if (legendBtn) legendBtn.textContent = "Mostrar";
  }

  if (legendBtn && legendBody){
    legendBtn.addEventListener("click", () => {
      const collapsed = legendBody.classList.toggle("is-collapsed");
      legendBtn.textContent = collapsed ? "Mostrar" : "Ocultar";
    });
  }
}

/* ================= COLORS (placeholder; punto 7 lo ajustamos luego) ================= */
const PRATE_LEVELS = [1,30,60,90,120,180,240,360,500,600,700,800,1000];
const PRATE_COLORS = [
  "#ffffff", "#ffffff", "#fee391", "#fec44f", "#addd8e", "#78c679",
  "#41ab5d", "#238443", "#1f78b4", "#225ea8", "#253494", "#54278f", "#7a0177"
];

function hexToRGBA(hex, alpha=255){
  const c = hex.replace("#","");
  return [
    parseInt(c.substring(0,2),16),
    parseInt(c.substring(2,4),16),
    parseInt(c.substring(4,6),16),
    alpha
  ];
}

function getColorPrate(v){
  if (!isFinite(v) || v < 1) return [255,255,255,0];
  for (let i = 0; i < PRATE_LEVELS.length - 1; i++){
    if (v >= PRATE_LEVELS[i] && v < PRATE_LEVELS[i+1]){
      return hexToRGBA(PRATE_COLORS[i+1], 200);
    }
  }
  return hexToRGBA(PRATE_COLORS[PRATE_COLORS.length - 1], 200);
}

function buildLegendHTML(periodLabel){
  let html = `<b>${VAR_LABEL} (${VAR_UNITS})</b><br>`;
  html += `<span style="font-size:11px">${periodLabel}</span><br><br>`;

  for (let i = 0; i < PRATE_LEVELS.length - 1; i++){
    html += `
      <div class="legend-row">
        <div class="legend-color-box" style="background:${PRATE_COLORS[i+1]}"></div>
        <span>${PRATE_LEVELS[i]} – ${PRATE_LEVELS[i+1]}</span>
      </div>
    `;
  }

  html += `
    <div class="legend-row">
      <div class="legend-color-box" style="background:${PRATE_COLORS[PRATE_COLORS.length-1]}"></div>
      <span>&gt; ${PRATE_LEVELS[PRATE_LEVELS.length-1]}</span>
    </div>
  `;
  return html;
}

/* ================= RENDER ================= */
function normalizeLon(lon){ return (lon > 180) ? lon - 360 : lon; }

function drawRaster(data){
  const lat = data.grid.lat;
  const lon = data.grid.lon.map(normalizeLon);
  const z   = data.grid.data;

  const ny = lat.length;
  const nx = lon.length;

  const canvas = document.createElement("canvas");
  canvas.width = nx;
  canvas.height = ny;

  const ctx = canvas.getContext("2d");
  const img = ctx.createImageData(nx, ny);

  const latIncreasing = lat[1] > lat[0];

  for (let i = 0; i < ny; i++){
    for (let j = 0; j < nx; j++){
      const v = z[i][j];
      if (v == null || !isFinite(v)) continue;

      const rgba = getColorPrate(v);
      const y = latIncreasing ? (ny - 1 - i) : i;
      const k = (y * nx + j) * 4;

      img.data[k]   = rgba[0];
      img.data[k+1] = rgba[1];
      img.data[k+2] = rgba[2];
      img.data[k+3] = rgba[3];
    }
  }

  ctx.putImageData(img, 0, 0);

  const dLat = Math.abs(lat[1] - lat[0]);
  const dLon = Math.abs(lon[1] - lon[0]);

  const bounds = [
    [lat[0] - dLat / 2, lon[0] - dLon / 2],
    [lat[lat.length - 1] + dLat / 2, lon[lon.length - 1] + dLon / 2]
  ];

  if (rasterOverlay) map.removeLayer(rasterOverlay);
  rasterOverlay = L.imageOverlay(canvas.toDataURL(), bounds, {opacity:0.85, interactive:false}).addTo(map);
  rasterOverlay.getElement().style.imageRendering = "pixelated";

  currentData._img = { width: nx, height: ny, bounds: rasterOverlay.getBounds() };
}

function valueAtPixel(latlng){
  if (!currentData || !currentData._img) return null;

  const img = currentData._img;
  const bounds = img.bounds;

  const x = (latlng.lng - bounds.getWest()) / (bounds.getEast() - bounds.getWest());
  const y = (bounds.getNorth() - latlng.lat) / (bounds.getNorth() - bounds.getSouth());
  if (x < 0 || x > 1 || y < 0 || y > 1) return null;

  const fx = x * (img.width - 1);
  let fy = y * (img.height - 1);

  const latIncreasing = currentData.grid.lat[1] > currentData.grid.lat[0];
  if (latIncreasing) fy = (img.height - 1) - fy;

  const i0 = Math.floor(fy), j0 = Math.floor(fx);
  const i1 = i0 + 1, j1 = j0 + 1;
  if (i1 >= img.height || j1 >= img.width) return null;

  const g = currentData.grid.data;
  const q11 = g[i0][j0], q21 = g[i0][j1], q12 = g[i1][j0], q22 = g[i1][j1];

  if ([q11,q21,q12,q22].every(v => v == null || !isFinite(v))) return null;

  const dx = fx - j0, dy = fy - i0;
  const v = q11*(1-dx)*(1-dy) + q21*dx*(1-dy) + q12*(1-dx)*dy + q22*dx*dy;
  return isFinite(v) ? v : null;
}

/* ================= DATA ================= */
function loadManifest(){
  fetch(`${currentType}/auto_manifest.json`)
    .then(r => r.json())
    .then(m => {
      steps = m.files || m;

      const sel = document.getElementById("periodSelect");
      sel.innerHTML = steps.map(f => `<option value="${f}">${prettyFromName(f)}</option>`).join("");

      loadGrid();
    })
    .catch(err => console.error("[manifest]", err));
}

function loadGrid(){
  const sel = document.getElementById("periodSelect");
  if (!sel.value) return;

  fetch(`${currentType}/${sel.value}`)
    .then(r => r.json())
    .then(json => {
      currentData = json;
      drawRaster(json);

      const body = document.querySelector(".legend-body");
      if (body){
        body.innerHTML = buildLegendHTML(
          `${currentType === "mensual" ? "Mensual" : "Bimestral"} – ${prettyFromName(sel.value)}`
        );
      }
    })
    .catch(err => console.error("[grid]", err));
}

/* ================= EVENTS ================= */
document.getElementById("typeToggle").onchange = e =>{
  currentType = e.target.checked ? "bimestral" : "mensual";
  loadManifest();
};
document.getElementById("periodSelect").onchange = loadGrid;

window.onload = ()=>{
  initMap();
  loadManifest();
  loadMexicoBoundaries();  // Punto 1 completo
  setupCollapsibles();     // Punto 2 completo
};
</script>

</body>
</html>
